name: 'Run code style tools'

on:
    pull_request:
        paths:
            - '**/*.php'
            - '.github/workflows/*'
    push:
        paths:
            - '**/*.php'
            - '.github/workflows/*'

jobs:
    cs:
        name: 'Check coding style'
        runs-on: 'ubuntu-20.04'

        steps:
            - name: 'Checkout current revision'
              uses: 'actions/checkout@v3'

            - name: 'Setup PHP'
              uses: 'shivammathur/setup-php@v2'
              with:
                  php-version: '8.1'
                  tools: 'composer'
                  coverage: 'none'

            - name: 'Discover Composer cache directory'
              id: 'cachedir'
              run: 'echo "::set-output name=path::$(composer global config cache-dir)"'

            - name: 'Share Composer cache across runs'
              uses: 'actions/cache@v3'
              with:
                  path: '${{ steps.cachedir.outputs.path }}'
                  key: "composer-${{ github.job }}-${{ hashFiles('**/composer.json') }}"
                  restore-keys: |
                      composer-${{ github.job }}-
                      composer-

            - name: 'Install dependencies with Composer'
              run: 'composer install --prefer-dist --no-interaction'

            - name: 'Run PHP CodeSniffer'
              run: 'composer run-script cs-check -- -n'

    stan:
        name: 'Static code analyzer'
        runs-on: 'ubuntu-20.04'
        continue-on-error: true

        steps:
            - name: 'Checkout current revision'
              uses: 'actions/checkout@v3'

            - name: 'Setup PHP'
              uses: 'shivammathur/setup-php@v2'
              with:
                  php-version: '8.1'
                  tools: 'composer'
                  coverage: 'none'

            - name: 'Discover Composer cache directory'
              id: 'cachedir'
              run: 'echo "::set-output name=path::$(composer global config cache-dir)"'

            - name: 'Share Composer cache across runs'
              uses: 'actions/cache@v3'
              with:
                  path: '${{ steps.cachedir.outputs.path }}'
                  key: "composer-${{ github.job }}-${{ hashFiles('**/composer.json') }}"
                  restore-keys: |
                      composer-${{ github.job }}-
                      composer-

            - name: 'Install dependencies with Composer'
              run: 'composer install --prefer-dist --no-interaction'

            - name: 'Run PHP STAN'
              run: 'composer run-script stan -- --no-progress --error-format=github'
